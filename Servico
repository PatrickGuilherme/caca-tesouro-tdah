using MercadinhoAPI.Models;
using System;
using System.Collections.Generic;
using System.Linq;

namespace MercadinhoAPI.Services
{
    public class JogoService
    {
        private readonly Random random = new Random();
        private readonly List<Item> catalogo;
        private int pontuacao = 0;

        public JogoService()
        {
            catalogo = new List<Item>
            {
                new Item { Nome = "Maçã", Preco = 2.50m },
                new Item { Nome = "Banana", Preco = 1.80m },
                new Item { Nome = "Leite", Preco = 5.00m },
                new Item { Nome = "Pão", Preco = 3.20m },
                new Item { Nome = "Queijo", Preco = 7.50m },
                new Item { Nome = "Refrigerante", Preco = 6.00m },
                new Item { Nome = "Chocolate", Preco = 4.75m }
            };
        }

        public Cliente GerarCliente()
        {
            string[] nomes = { "João", "Maria", "Pedro", "Ana", "Lucas", "Carla" };
            string nome = nomes[random.Next(nomes.Length)];

            int qtdItens = random.Next(1, 5);
            var itens = new List<Item>();

            for (int i = 0; i < qtdItens; i++)
            {
                itens.Add(catalogo[random.Next(catalogo.Count)]);
            }

            decimal total = itens.Sum(i => i.Preco);
            decimal valorPago = GerarValorPago(total);

            return new Cliente
            {
                Nome = nome,
                ItensComprados = itens,
                ValorPago = valorPago
            };
        }

        public (bool correto, decimal trocoCorreto, int pontuacao) VerificarTroco(Cliente cliente, decimal respostaJogador)
        {
            decimal trocoCorreto = cliente.TrocoCorreto;

            bool correto = Math.Abs(trocoCorreto - respostaJogador) < 0.01m;

            if (correto) pontuacao++;

            return (correto, trocoCorreto, pontuacao);
        }

        private decimal GerarValorPago(decimal total)
        {
            decimal[] notas = { 5, 10, 20, 50, 100 };
            decimal nota = notas[random.Next(notas.Length)];

            while (nota < total)
                nota = notas[random.Next(notas.Length)];

            return nota;
        }
    }
}
